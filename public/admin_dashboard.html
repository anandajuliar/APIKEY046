<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"> 
</head>
<body class="bg-light">

    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-primary">User API Key Management</h1>
            <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
        
        <div id="statusMessage" class="alert alert-info">Memuat data...</div>

        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>API Key</th>
                    <th>Status</th>
                    <th>Masa Berlaku</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                </tbody>
        </table>
    </div>

    <script>
        const API_USERS_URL = '/admin/users';
        const token = localStorage.getItem('adminToken');
        const statusMessage = document.getElementById('statusMessage');
        const usersTableBody = document.getElementById('usersTableBody');
        
        // Cek Autentikasi Saat Memuat Halaman
        if (!token) {
            statusMessage.className = 'alert alert-danger';
            statusMessage.textContent = 'Akses ditolak. Silakan login terlebih dahulu.';
            setTimeout(() => { window.location.href = 'admin_login.html'; }, 2000);
        } else {
            fetchUserData(token);
        }

        async function fetchUserData(jwtToken) {
            try {
                const response = await fetch(API_USERS_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    statusMessage.style.display = 'none';
                    renderTable(data);
                } else {
                    // Jika token invalid/expired, paksa logout
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.textContent = `Error ${response.status}: Token invalid/expired.`;
                    document.getElementById('logoutBtn').click(); 
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = "Gagal terhubung ke server API.";
            }
        }

        function renderTable(users) {
            usersTableBody.innerHTML = '';
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada user terdaftar.</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = usersTableBody.insertRow();
                const expiryDate = new Date(user.OUT_OF_DATE).toLocaleDateString();
                let statusClass = user.STATUS === 'Active' ? 'badge bg-success' : 'badge bg-danger';

                row.innerHTML = `
                    <td>${user.ID}</td>
                    <td>${user.FIRST_NAME} ${user.LAST_NAME}</td>
                    <td>${user.EMAIL}</td>
                    <td style="font-size: 0.8rem; word-break: break-all;">${user.KEY_VALUE}</td>
                    <td><span class="${statusClass}">${user.STATUS}</span></td>
                    <td>${expiryDate}</td>
                `;
            });
        }
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        });
    </script>

</body>
</html>